---
layout: post
title: Ghostscript 7.07 のコンパイル
date: 2021-08-26 10:30 +0900
---
Ghostscript 7.07 のソースからコンパイルを行った。

## 参考

+ [TeX Wiki: Ghostscript 7.07](https://texwiki.texjp.org/?Ghostscript%207.07)
+ [以前に書いたページ](https://www.uconst.org/blog/archives/38)

## ダウンロード

+ **Ghostscript 7.07 のソース**<br>
    Sourceforge にあった Ghostscript のページ
    ([gnu-gs](https://sourceforge.net/projects/ghostscript/files/gnu-gs/7.07/))
    が削除されたため、7.07 は入手困難になっているが、7.07b が入手可能。
    + **ghostscript-7.07b.tar.gz**<br>
        [GNU のサイト](https://ftp.gnu.org/gnu/ghostscript/),
        [山形大のミラー](https://ftp.yz.yamagata-u.ac.jp/pub/GNU/ghostscript/)
        から入手できる。
+ **パッチ**<br>
    そのままだと多くの TrueType フォントでエラーとなってしまうので、
    [山田泰司さんのページ](https://www.aihara.co.jp/~taiji/gyve/)で紹介されているパッチが必要。
    パッチの数が多いので、パッチのダウンロードもコンパイルの節に記述する。
+ **依存ライブラリ** (jpeg, libpng, zlib)
    + **jpeg**<br>
        jpegsrc.v6b.tar.gz が必要。
        Sourceforge の libjpeg のページ
        ([libjpeg](https://sourceforge.net/projects/libjpeg/files/libjpeg/6b/)),
        [GNU のサイト](https://ftp.gnu.org/gnu/ghostscript/),
        [山形大のミラー](https://ftp.yz.yamagata-u.ac.jp/pub/GNU/ghostscript/)
        からダウンロードできる。
    + **libpng**<br>
        最新の 1.6 系列ではコンパイルできない。
        1.4系列であれば可能。
        1.4系列の最終版
        [libpng-1.4.22.tar.gz](https://sourceforge.net/projects/libpng/files/libpng14/1.4.22/libpng-1.4.22.tar.gz/download)
        が Sourceforge の libpng のページ
        ([libpng](https://sourceforge.net/projects/libpng/files/))
        からダウンロードできる。
    + zlib<br>
        システム付属の zlib が使用できることが多い。
        その場合は zlib のソースは不要。
        NetBSD 9 の場合でも不要だった。
        ソースからコンパイルする場合は、1.1 系列が必要。
        zlib-1.1.3.tar.gz が
        [GNU のサイト](https://ftp.gnu.org/gnu/ghostscript/),
        [山形大のミラー](https://ftp.yz.yamagata-u.ac.jp/pub/GNU/ghostscript/)
        からダウンロードできる。
+ **Ghostscript のフォント**<br>
    Sourceforge の Ghostscript font のページ
    ([gs-fonts](https://sourceforge.net/projects/gs-fonts/))
    からダウンロードできる。
    同ページには同内容でライセンスが異なるパッケージが用意されているので、
    適切なものを使用することが望ましい。
    + [ghostscript-fonts-std-8.11.tar.gz (GPL)](https://sourceforge.net/projects/gs-fonts/files/gs-fonts/8.11%20%28base%2035%2C%20GPL%29/ghostscript-fonts-std-8.11.tar.gz/download)
    + [ghostscript-fonts-other-6.0.tar.gz (AFPL)](https://sourceforge.net/projects/gs-fonts/files/gs-fonts/6.0%20%28misc%2C%20AFPL%29/ghostscript-fonts-other-6.0.tar.gz/download)
+ **CMap Resource**<br>
    GitHub の Adobe Type tools にある
    [cmap-resources](https://github.com/adobe-type-tools/cmap-resources)
    からダウンロードできる。
    同[リリースページ](https://github.com/adobe-type-tools/cmap-resources/releases)から、
    "Source code (tar.gz)" をダウンロードすればよい。
    現時点での最新版は
    [cmap-resources-20190730.tar.gz](https://github.com/adobe-type-tools/cmap-resources/archive/refs/tags/20190730.tar.gz)
    (ダウンロードする際にファイル名が付与される)。


## コンパイルとインストール

#### ghostscript-7.07b のソースを展開する

```
tar xzf ghostscript-7.07b.tar.gz
```

#### ghostscript-7.07b のソースにパッチを適用する

[山田泰司さんのページ](https://www.aihara.co.jp/~taiji/gyve/)で紹介されているパッチをダウンロードして
ghostscript-7.07b のソースにパッチを適用する。
数が多いので、シェルスクリプトとして記述した。

##### パッチファイルのダウンロード

ダウンロードのスクリプトはこんな感じに列挙した。
パッチを当てる順番とか重要なので、
元の解説文書を参考に4段階でパッチを当てるよう整理している。

今のところはすべてのパッチをダウンロードできているが、
フォルダ名のパスに tmp が含まれていると、
いつまでダウンロードが有効か心配になる。

```sh
#! /bin/sh
(
    mkdir step1
    cd step1
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/tagoh.jp_junk/ghostscript-7.07-bigposttable.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/tagoh.jp_junk/ghostscript-7.07-gsublookuptable.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/tagoh.jp_junk/ghostscript-7.07-coverage-glyphcount.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/fix_rename_font_gs_cidfn.ps.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/fix_cidfontname_Encoding_CIDToGIDMap_DW_W.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/modify_ps2pdfwr.patch
)
(
    mkdir step2
    cd step2
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/ghostscript-7.07-bigcmaptable.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/ghostscript-7.07-noglyph-gid0.patch
)
(
    mkdir step3
    cd step3
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/fix_cidfonttype2_Adobe-CNS1-4.patch
)
(
    mkdir step4
    cd step4
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/ghostscript-7.07-seekCFFtable.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/ghostscript-7.07-readFDSelect.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/ghostscript-7.07-write_GSubrs.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/ghostscript-7.07-nosyoffsetcheck.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/fix_cidfonttype2_Adobe-Japan1-6.patch
    curl -RO https://www.aihara.co.jp/~taiji/gyve/tmp/modify_ps2pdfwr-20050921.patch
)
```

##### パッチファイルを適用する

ダウンロードしたパッチファイルを順序よく適用していく。
指定する patch のオプションや、
実行するディレクトリがパッチファイルによって異なるので、
こちらもシェルスクリプトを記述して確認しながら適用した。

```sh
#! /bin/sh

target=../ghostscript-7.07b

patch -p1 -d $target      < step1/ghostscript-7.07-bigposttable.patch
patch -p1 -d $target      < step1/ghostscript-7.07-gsublookuptable.patch
patch -p1 -d $target      < step1/ghostscript-7.07-coverage-glyphcount.patch
patch -p1 -d $target      < step1/fix_rename_font_gs_cidfn.ps.patch
patch -p1 -d $target      < step1/fix_cidfontname_Encoding_CIDToGIDMap_DW_W.patch
patch -p0 -d $target/lib  < step1/modify_ps2pdfwr.patch

patch -p0 -d $target      < step2/ghostscript-7.07-bigcmaptable.patch
patch -p0 -d $target      < step2/ghostscript-7.07-noglyph-gid0.patch

patch -p0 -d $target      < step3/fix_cidfonttype2_Adobe-CNS1-4.patch

patch -p0 -d $target      < step4/ghostscript-7.07-seekCFFtable.patch
patch -p0 -d $target      < step4/ghostscript-7.07-readFDSelect.patch
patch -p0 -d $target      < step4/ghostscript-7.07-write_GSubrs.patch
patch -p0 -d $target      < step4/ghostscript-7.07-nosyoffsetcheck.patch
patch -p0 -d $target      < step4/fix_cidfonttype2_Adobe-Japan1-6.patch
patch -p0 -d $target/lib  < step4/modify_ps2pdfwr-20050921.patch
```

#### 依存ライブラリのソースを展開する

NetBSD 9 (他の多くのシステムも) ではシステムの zlib が使用できるので、
jpeg と libpng のみソースを設置する。

```console
$ cd ghostscript-7.07b
$ tar xzf ../jpegsrc.v6b.tar.gz
$ mv jpeg-6b jpeg
```

```sh
$ cd ghostscript-7.07b
$ tar xzf ../libpng-1.4.22.tar.gz
$ mv libpng-1.4.22 libpng
```

#### configure を実行する

```
$ ./configure
```

#### コンパイル (make) の実行

GNU make で make を実行する。
NetBSD 環境なので gmake (GNU make) をインストールし、
gamke を実行する。

```
$ gmake
```

#### インストール (make install) の実行

gmake install を実行して、インストールを行う。
デフォルトの設定のままであれば
/usr/local/bin 下に実行ファルが、
/usr/local/share/ghostscript 下に他の必要ファイル群がインストールされる。

```
$ gmake install
```

そのままだと、Resource の参照先が適切でないので修正する必要がある。
lib/gs_res.ps (/usr/local/share/ghostscript/7.07/lib/gs_res.ps)
の249–250行

```
/FontResourceDir (/Resource/Font/) readonly .forcedef  % pssys'params is r-o
/GenericResourceDir (/Resource/) readonly .forcedef    % pssys'params is r-o
```

の /Resource/ （2箇所）を
/usr/local/teTeX/share/ghostscript/Resource/ 
のように修正する。


### 標準フォントのインストール

標準フォントは /usr/local/ghostscript/fonts に設置する。

```
$ sudo tar xzf ghostscript-fonts-std-8.11.tar.gz -C /usr/local/share/ghostscript
$ sudo tar xzf ghostscript-fonts-other-6.0.tar.gz -C /usr/local/share/ghostscript
```

ファイルのオーナーやパーミッションは環境に合わせて設定する。


### CMap Resource のインストール

ダウンロードした cmap-resouorce ファイルを展開し、
Adobe-Japan1-7 などのディレクトリの下にある
CMap ディレクトリを /usr/local/share/ghostscript/Resource にコピーする。

```
$ unzip cmap-resources-20190730.zip
$ cd cmap-resources
$ for d in Adobe-*; do sudo cp -r $d/CMap /usr/local/share/ghostscript/Resource; done
```

ファイルのパーミッションや、
タイムスタンプなどは環境や好みに合わせて設定する。


## 日本語 TrueType フォントの設置と設定


## 動作確認

```
GS_LIB=font gs -dBATCH -dNOPAUSE -sDEVICE=pngalpha -sPAPERSIZE=a4 -r150 -sOutputFile=result-p%d.png fontexample.ps
```

![result-p1.png]({{site.baseurl}}/images/2021-08-29-gs-result-p1.png)
![result-p2.png]({{site.baseurl}}/images/2021-08-29-gs-result-p2.png)
